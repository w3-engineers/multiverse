<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multiverse Client</title>
    <style>
        body {
            width: 600px;
            height: auto;
            margin: 0 auto;
            padding: 30px;
        }

        input {
            display: block;
            min-width: 400px;
            min-height: 30px;

        }

        div {
            padding: 10px;
        }

        select {
            min-width: 400px;
            min-height: 30px;
        }

        .chat-send input {
            width: 400px;
        }

        .chat-history {
            display: block;
            border: 1px solid gray;
        }

        .chat .status {
            float: right;
        }

        .chat .me {
            font-weight: bold;
            color: blue;
        }

        .others-msg {
            background: powderblue;
        }

    </style>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
</head>
<body>

<div class="user-info">

</div>

<div class="user-list">
    <div>Select User to Chat!</div>
    <select>
        <option value="">---Select---</option>
    </select>
</div>

<div class="chat-send">
    <input type="text" placeholder="Type your message and press enter."/>
</div>

<div>
    <div>
        <h3>Chat
            <History></History>
        </h3>
    </div>
    <div class="chat-history">

    </div>
</div>


<script>
    user_info_dom = document.querySelector(".user-info");
    user_list_dom = document.querySelector(".user-list select");
    user_send_message_dom = document.querySelector(".chat-send input");
    user_chat_history_dom = document.querySelector(".chat-history");
    let sent = "✓";
    let delivered = "✓✓";

    EMIT_RCV_ACK = "rcv_ack";
    EMIT_SENT_ACK = "sent_ack";
    EMIT_CONNECT = "connect";
    EMIT_DISCONNECT = "disconnect";
    EMIT_USER_LIST = "user_list";
    EMIT_REGISTER = "register";
    EMIT_NEW_MESSAGE = "new_message";
    EMIT_SEND_MESSAGE = "send_message";

    let appname = "telemesh";

    let name = prompt("What will be your name?", "");

    if (name == null || name.length === 0) {
        alert("A name Required.");
        window.location.reload();
    }

    let socket = io('https://multiverse.w3engineers.com/');
    let connected = false;

    socket.on(EMIT_CONNECT, function () {
        console.log(EMIT_CONNECT);
        console.log("Connected as " + name);
        connected = true;
        user_info_dom.innerHTML = "<h1>Welcome " + name + "!</h1>";
    });

    //events
    socket.on(EMIT_USER_LIST, function (data) {
        console.log(EMIT_USER_LIST);
        console.log(data);
        data = JSON.parse(data);

        for (let a = 0; a < user_list_dom.options.length; a++) {
            user_list_dom.options.remove(a);
        }

        for (let i = 0; i < data.length; i++) {
            if (data[i] !== name) {
                let opt = document.createElement('option');
                opt.innerHTML = data[i];
                opt.value = data[i];
                user_list_dom.append(opt);
            }

        }
    });

    socket.on(EMIT_REGISTER, function (data) {
        console.log(EMIT_REGISTER);
        console.log(data);
        socket.emit(EMIT_REGISTER, appname, name);
    });

    socket.on(EMIT_NEW_MESSAGE, function (data) {

        console.log(EMIT_NEW_MESSAGE);
        console.log(data);
        data = JSON.parse(data);

        user_chat_history_dom.innerHTML = user_chat_history_dom.innerHTML +
            "<div class='chat others-msg'><span class='me'>" + data.sender + ": </span>" +
            "<span class='text'>" + data.text + "</span></div>";
    });

    socket.on(EMIT_RCV_ACK, function (data) {
        console.log(EMIT_RCV_ACK);
        console.log(data);

        data = JSON.parse(data);
        let ack_dom = document.getElementById(data.scope + data.txn);
        ack_dom.innerHTML = delivered;
    });

    socket.on(EMIT_SENT_ACK, function (data) {
        console.log(EMIT_SENT_ACK);
        console.log(data);

        data = JSON.parse(data);
        let ack_dom = document.getElementById(data.scope + data.txn);
        ack_dom.innerHTML = sent;
    });

    socket.on(EMIT_DISCONNECT, function () {
        console.log(EMIT_DISCONNECT);
        connected = false;

        alert("Connection closed.");
        window.location.reload();
    });


    //actions from clients
    user_send_message_dom.onkeypress = function (event) {
         console.log(EMIT_SEND_MESSAGE);
        if (event.key === 'Enter') {

            let msg = user_send_message_dom.value;
            let user_option_dom = user_list_dom.options[user_list_dom.selectedIndex];
            let recv = '';
            if (user_option_dom !== undefined) {
                recv = user_option_dom.value;
            }
            if (connected === true && msg !== '' && recv !== '') {

                let timeStampInMs = window.performance && window.performance.now && window.performance.timing && window.performance.timing.navigationStart ? window.performance.now() + window.performance.timing.navigationStart : Date.now();
                let message = JSON.stringify({
                    action: "send",
                    receiver: recv,
                    text: msg, txn: timeStampInMs, app: appname
                });
                socket.emit(EMIT_SEND_MESSAGE, appname, name, message);
                user_chat_history_dom.innerHTML = user_chat_history_dom.innerHTML +
                    "<div class='chat'><span class='me'>Me: </span>" +
                    "<span class='text'>" + msg + "</span>" +
                    "<span class='status' id='" + appname + timeStampInMs + "'></span></div>";

                user_send_message_dom.value = '';
                console.log("send message set!");
            } else {
                alert("Receiver and Message Missing!");
            }
        }

    };

    /*user_list_dom.onclick = function (event) {
        socket.emit(EMIT_USER_LIST);
    }*/

</script>
</body>
</html>
